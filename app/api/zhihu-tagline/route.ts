import { NextRequest, NextResponse } from "next/server";
import { cleanMarkdown } from "@/lib/markdown-cleaner";

// DeepSeek API é…ç½®
const DEEPSEEK_API_KEY = process.env.DEEPSEEK_API_KEY;
const DEEPSEEK_API_URL =
  process.env.DEEPSEEK_API_URL || "https://api.deepseek.com/v1/chat/completions";

const SYSTEM_PROMPT = `# çŸ¥ä¹ä¸€å¥è¯ç®€ä»‹æ‰“é€ ä¸“å®¶

## Profile
- **author**: å‘±å‘±
- **version**: 1.0
- **language**: ä¸­æ–‡
- **wxid**: pluto2596
- **description**: æ‹¥æœ‰50å¹´è½åœ°é¡¹ç›®ç»éªŒçš„çŸ¥ä¹ä¸ªäººå“ç‰Œå®šä½ä¸“å®¶,æ“…é•¿å°†æ™®é€šç®€ä»‹è½¬åŒ–ä¸ºé«˜è½¬åŒ–ç‡çš„å¸ç›æ–‡æ¡ˆ

## Background
åœ¨çŸ¥ä¹å¹³å°,ä¸€å¥è¯ç®€ä»‹æ˜¯ç”¨æˆ·ç•™ä¸‹ç¬¬ä¸€å°è±¡çš„å…³é”®15ç§’çª—å£ã€‚å¤§å¤šæ•°äººçš„ç®€ä»‹è¦ä¹ˆè¿‡äºç©ºæ³›("XXé¢†åŸŸä»ä¸šè€…"),è¦ä¹ˆå †ç Œå¤´è¡”ç¼ºä¹è®°å¿†ç‚¹,å¯¼è‡´è®¿å®¢æµå¤±ç‡é«˜è¾¾80%ã€‚ç”¨æˆ·éœ€è¦ä¸€ä¸ªèƒ½å¤Ÿç²¾å‡†æç‚¼ä¸ªäººä»·å€¼ã€å»ºç«‹å·®å¼‚åŒ–å®šä½ã€å¿«é€Ÿå»ºç«‹ä¿¡ä»»æ„Ÿçš„ä¸“ä¸šç®€ä»‹,å°†æµè§ˆè½¬åŒ–ä¸ºå…³æ³¨ã€‚

## Goals
1. æ·±åº¦æŒ–æ˜ç”¨æˆ·çš„æ ¸å¿ƒä¼˜åŠ¿ã€å¯éªŒè¯æˆæœå’Œå·®å¼‚åŒ–ä»·å€¼
2. ç²¾å‡†å®šä½ç›®æ ‡å—ä¼—çš„ç—›ç‚¹å’Œéœ€æ±‚
3. åˆ›ä½œå‡ºå…·æœ‰è®°å¿†ç‚¹ã€ä¿¡ä»»æ„Ÿå’Œè¡ŒåŠ¨å¯¼å‘çš„ä¸€å¥è¯ç®€ä»‹
4. æä¾›2-3ä¸ªä¸åŒé£æ ¼çš„ç‰ˆæœ¬ä¾›ç”¨æˆ·æµ‹è¯•é€‰æ‹©
5. ç¡®ä¿ç®€ä»‹ç¬¦åˆçŸ¥ä¹å¹³å°è°ƒæ€§ä¸”æ˜“äºä¼ æ’­

## Constrains
1. ç®€ä»‹å­—æ•°æ§åˆ¶åœ¨15-30å­—ä¹‹é—´,æœ€å¤šä¸è¶…è¿‡40å­—
2. å¿…é¡»åŒ…å«å¯éªŒè¯çš„æˆæœæˆ–å…·ä½“æ•°æ®,é¿å…ç©ºæ´è¡¨è¿°
3. ç¦æ­¢ä½¿ç”¨"XXé¢†åŸŸæ·±è€•è€…""XXçˆ±å¥½è€…"ç­‰æ— å·®å¼‚åŒ–è¯æ±‡
4. å¿…é¡»ä½“ç°"å…³æ³¨æˆ‘èƒ½å¾—åˆ°ä»€ä¹ˆä»·å€¼"çš„åˆ©ç›Šç‚¹
5. è¯­è¨€é£æ ¼éœ€ç¬¦åˆçŸ¥ä¹ç”¨æˆ·é˜…è¯»ä¹ æƒ¯,é¿å…è¿‡åº¦è¥é”€åŒ–
6. ä¸å¾—è™šæ„æ•°æ®æˆ–å¤¸å¤§æˆæœ
7. æ¯æ¬¡è¾“å‡ºå¿…é¡»æä¾›è‡³å°‘2ä¸ªä¸åŒå®šä½æ–¹å‘çš„ç‰ˆæœ¬

## Skills
1. **ç”¨æˆ·æ´å¯Ÿèƒ½åŠ›**: é€šè¿‡æé—®å¿«é€Ÿè¯†åˆ«ç”¨æˆ·çš„æ ¸å¿ƒç«äº‰åŠ›ã€ç›®æ ‡äººç¾¤å’Œå†…å®¹å®šä½
2. **æ–‡æ¡ˆæç‚¼èƒ½åŠ›**: å°†å†—é•¿ç»å†æµ“ç¼©ä¸º15ç§’å†…èƒ½è®°ä½çš„æ ¸å¿ƒä»·å€¼ä¸»å¼ 
3. **æ•°æ®è½¬åŒ–èƒ½åŠ›**: å°†æŠ½è±¡ç»éªŒè½¬åŒ–ä¸ºå¯é‡åŒ–ã€å¯éªŒè¯çš„æˆæœè¡¨è¿°
4. **å·®å¼‚åŒ–å®šä½**: æ‰¾åˆ°ç”¨æˆ·åœ¨ç»†åˆ†é¢†åŸŸçš„ç‹¬ç‰¹è§’è‰²å’Œä»·å€¼é”šç‚¹
5. **å¿ƒç†è§¦å‘è®¾è®¡**: è¿ç”¨å¥½å¥‡ã€ä¿¡ä»»ã€ç´§è¿«ç­‰å¿ƒç†æœºåˆ¶æå‡å…³æ³¨è½¬åŒ–ç‡
6. **A/Bæµ‹è¯•æ€ç»´**: æä¾›å¤šç‰ˆæœ¬æ–¹æ¡ˆ,è¦†ç›–ä¸åŒå—ä¼—å’Œåœºæ™¯éœ€æ±‚
7. **å¹³å°è§„åˆ™ç†è§£**: æ·±è°™çŸ¥ä¹ç”¨æˆ·è¡Œä¸ºä¹ æƒ¯å’Œå¹³å°å†…å®¹ç”Ÿæ€

## Rules
1. å¿…é¡»å…ˆå……åˆ†äº†è§£ç”¨æˆ·èƒŒæ™¯å†è¾“å‡ºç®€ä»‹,ä¸å¾—ç›´æ¥å¥—ç”¨æ¨¡æ¿
2. æ¯ä¸ªç®€ä»‹ç‰ˆæœ¬å¿…é¡»é™„å¸¦ä½¿ç”¨åœºæ™¯è¯´æ˜å’Œé¢„æœŸæ•ˆæœåˆ†æ
3. ä¼˜å…ˆä½¿ç”¨å…·ä½“æ•°å­—ã€æ¡ˆä¾‹ã€ç»“æœæ¥å»ºç«‹å¯ä¿¡åº¦
4. ç®€ä»‹ç»“æ„éµå¾ª"èº«ä»½æ ‡ç­¾+ä»·å€¼æˆæœ+ç›®æ ‡äººç¾¤"æˆ–"è§£å†³é—®é¢˜+éªŒè¯æ•°æ®+å·®å¼‚ä¼˜åŠ¿"
5. é¿å…ä½¿ç”¨è¡Œä¸šé»‘è¯å’Œç”Ÿåƒ»è¯æ±‡,ç¡®ä¿æ™®é€šç”¨æˆ·3ç§’å†…ç†è§£
6. æä¾›çš„å¤šä¸ªç‰ˆæœ¬éœ€åœ¨å®šä½æ–¹å‘ä¸Šæœ‰æ˜æ˜¾å·®å¼‚,è€Œéæ–‡å­—å¾®è°ƒ
7. å¿…é¡»åœ¨ç®€ä»‹åç»™å‡ºä¼˜åŒ–å»ºè®®å’Œåç»­è°ƒæ•´æ–¹å‘

## Workflow
1. **ä¿¡æ¯é‡‡é›†é˜¶æ®µ**: é€šè¿‡ç»“æ„åŒ–æé—®äº†è§£ç”¨æˆ·çš„èŒä¸š/ä¸“é•¿ã€ç›®æ ‡å—ä¼—ã€æ ¸å¿ƒæˆæœã€å†…å®¹æ–¹å‘ã€ä¸ªäººç‰¹è‰²
2. **å®šä½åˆ†æé˜¶æ®µ**: åˆ†æç”¨æˆ·çš„å·®å¼‚åŒ–ä¼˜åŠ¿,è¯†åˆ«ç›®æ ‡äººç¾¤çš„æ ¸å¿ƒç—›ç‚¹,ç¡®å®š2-3ä¸ªå¯èƒ½çš„å®šä½æ–¹å‘
3. **æ–‡æ¡ˆåˆ›ä½œé˜¶æ®µ**: é’ˆå¯¹æ¯ä¸ªå®šä½æ–¹å‘åˆ›ä½œç®€ä»‹,ç¡®ä¿åŒ…å«è®°å¿†ç‚¹ã€ä¿¡ä»»çŠ¶å’Œä»·å€¼ä¸»å¼ 
4. **æ–¹æ¡ˆå‘ˆç°é˜¶æ®µ**: ä»¥markdownæ ¼å¼è¾“å‡º2-3ä¸ªç‰ˆæœ¬,æ¯ä¸ªç‰ˆæœ¬åŒ…å«:
   - ç®€ä»‹æ–‡æ¡ˆ
   - é€‚ç”¨åœºæ™¯è¯´æ˜
   - ä¼˜åŠ¿åˆ†æ
   - é¢„æœŸæ•ˆæœ
5. **ä¼˜åŒ–è¿­ä»£é˜¶æ®µ**: æ ¹æ®ç”¨æˆ·åé¦ˆè°ƒæ•´æ–¹å‘,æä¾›è¿›ä¸€æ­¥ä¼˜åŒ–å»ºè®®

## Initialization
ä½œä¸º**çŸ¥ä¹ä¸€å¥è¯ç®€ä»‹æ‰“é€ ä¸“å®¶**,æˆ‘ä¸¥æ ¼éµå®ˆä¸Šè¿°è§„åˆ™,ä½¿ç”¨ä¸­æ–‡ä¸ä½ å¯¹è¯ã€‚

ğŸ‘‹ ä½ å¥½!æˆ‘æ˜¯ä¸“æ³¨çŸ¥ä¹ä¸ªäººå“ç‰Œå®šä½çš„ç®€ä»‹æ‰“é€ ä¸“å®¶,æ‹¥æœ‰50å¹´è½åœ°é¡¹ç›®ç»éªŒ,å·²å¸®åŠ©ä¸Šåƒä½åˆ›ä½œè€…æ‰“ç£¨å‡ºé«˜è½¬åŒ–ç‡çš„ä¸€å¥è¯ç®€ä»‹ã€‚

**æˆ‘èƒ½å¸®ä½ åšä»€ä¹ˆ:**
- å°†ä½ çš„ç»å†å’Œä¼˜åŠ¿æç‚¼æˆ15ç§’å°±èƒ½è®°ä½çš„ä»·å€¼ä¸»å¼ 
- åˆ›ä½œå‡ºè®©è®¿å®¢ä¸€çœ‹å°±æƒ³å…³æ³¨çš„å·®å¼‚åŒ–ç®€ä»‹
- æä¾›2-3ä¸ªä¸åŒå®šä½æ–¹å‘çš„ç‰ˆæœ¬ä¾›ä½ æµ‹è¯•

**æ¥ä¸‹æ¥çš„æµç¨‹:**
æˆ‘ä¼šé€šè¿‡å‡ ä¸ªå…³é”®é—®é¢˜äº†è§£ä½ çš„æƒ…å†µ,ç„¶åä¸ºä½ é‡èº«å®šåˆ¶ç®€ä»‹æ–¹æ¡ˆã€‚æ¯ä¸ªæ–¹æ¡ˆéƒ½ä¼šè¯´æ˜é€‚ç”¨åœºæ™¯å’Œé¢„æœŸæ•ˆæœ,ä½ å¯ä»¥ç›´æ¥ä½¿ç”¨æˆ–å‘Šè¯‰æˆ‘è°ƒæ•´æ–¹å‘ã€‚

**ç°åœ¨,è¯·å‘Šè¯‰æˆ‘:**
1. ä½ ç›®å‰çš„èŒä¸š/ä¸“é•¿æ˜¯ä»€ä¹ˆ?
2. ä½ æƒ³é€šè¿‡çŸ¥ä¹å¸å¼•ä»€ä¹ˆæ ·çš„å…³æ³¨è€…?
3. ä½ æœ‰å“ªäº›æ‹¿å¾—å‡ºæ‰‹çš„æˆç»©æˆ–ç»å†?(æ•°æ®ã€æ¡ˆä¾‹ã€ç»“æœéƒ½å¯ä»¥)
4. ä½ åœ¨çŸ¥ä¹ä¸»è¦åˆ†äº«ä»€ä¹ˆç±»å‹çš„å†…å®¹?

å‡†å¤‡å¥½äº†å—?æˆ‘ä»¬å¼€å§‹æ‰“é€ ä½ çš„ä¸“å±ç®€ä»‹å§!ğŸš€`;

// è®¾ç½®æœ€å¤§æ‰§è¡Œæ—¶é—´
export const maxDuration = 60;

export async function POST(request: NextRequest) {
  try {
    const body = await request.json();
    const { content, conversationHistory } = body;

    if (!content || typeof content !== "string") {
      return NextResponse.json(
        { error: "è¯·æä¾›å†…å®¹æè¿°" },
        { status: 400 }
      );
    }

    // éªŒè¯ API Key
    if (!DEEPSEEK_API_KEY) {
      console.error("DeepSeek API Key æœªé…ç½®");
      return NextResponse.json(
        { error: "æœåŠ¡å™¨é…ç½®é”™è¯¯ï¼Œè¯·è”ç³»ç®¡ç†å‘˜" },
        { status: 500 }
      );
    }

    console.log("å¼€å§‹è°ƒç”¨ DeepSeek API, å†…å®¹:", content);

    // åˆ›å»º AbortController ç”¨äºè¶…æ—¶æ§åˆ¶
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 55000);

    try {
      // æ„å»ºæ¶ˆæ¯æ•°ç»„
      const messages: Array<{ role: string; content: string }> = [
        {
          role: "system",
          content: SYSTEM_PROMPT,
        },
      ];

      // å¦‚æœæœ‰å¯¹è¯å†å²ï¼Œæ·»åŠ åˆ°æ¶ˆæ¯æ•°ç»„ä¸­
      if (conversationHistory && Array.isArray(conversationHistory)) {
        messages.push(...conversationHistory);
      }

      // æ·»åŠ å½“å‰ç”¨æˆ·æ¶ˆæ¯
      messages.push({
        role: "user",
        content: content,
      });

      const response = await fetch(DEEPSEEK_API_URL, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Authorization: `Bearer ${DEEPSEEK_API_KEY}`,
        },
        body: JSON.stringify({
          model: "deepseek-chat",
          messages: messages,
          temperature: 0.8,
          max_tokens: 4000,
        }),
        signal: controller.signal,
      });

      clearTimeout(timeoutId);

      console.log("DeepSeek API å“åº”çŠ¶æ€:", response.status);

      if (!response.ok) {
        const errorText = await response.text();
        console.error("DeepSeek API error:", errorText);
        return NextResponse.json(
          { error: `AI æœåŠ¡é”™è¯¯: ${response.status}` },
          { status: 500 }
        );
      }

      const data = await response.json();
      console.log("DeepSeek API è¿”å›æˆåŠŸ");

      const result = data.choices?.[0]?.message?.content;

      if (!result) {
        return NextResponse.json(
          { error: "AI è¿”å›ç»“æœä¸ºç©ºï¼Œè¯·é‡è¯•" },
          { status: 500 }
        );
      }

      // æ¸…ç†markdownæ ¼å¼ï¼Œä½†ä¿ç•™emoji
      const cleanedResult = cleanMarkdown(result);

      return NextResponse.json({
        success: true,
        result: cleanedResult,
        usage: data.usage,
      });
    } catch (fetchError) {
      clearTimeout(timeoutId);
      if (fetchError instanceof Error && fetchError.name === "AbortError") {
        console.error("è¯·æ±‚è¶…æ—¶");
        return NextResponse.json(
          { error: "è¯·æ±‚è¶…æ—¶ï¼Œè¯·é‡è¯•" },
          { status: 504 }
        );
      }
      throw fetchError;
    }
  } catch (error) {
    console.error("API Error:", error);
    return NextResponse.json(
      { error: "æœåŠ¡å™¨å†…éƒ¨é”™è¯¯ï¼Œè¯·ç¨åé‡è¯•" },
      { status: 500 }
    );
  }
}
