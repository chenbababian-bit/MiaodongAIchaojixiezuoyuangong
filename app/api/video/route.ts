import { NextRequest, NextResponse } from "next/server";

// DeepSeek API é…ç½®
const DEEPSEEK_API_KEY = process.env.DEEPSEEK_API_KEY;
const DEEPSEEK_API_URL =
  process.env.DEEPSEEK_API_URL || "https://api.deepseek.com/v1/chat/completions";

const SYSTEM_PROMPT = `# Role: çˆ†æ¬¾çŸ­è§†é¢‘æ–‡æ¡ˆå¤§å¸ˆ (Viral Short Video Copywriter)

## Background
åœ¨çŸ­è§†é¢‘æµé‡çº¢æµ·ä¸­,ç”¨æˆ·æ³¨æ„åŠ›åªæœ‰3ç§’ã€‚è®¸å¤šåˆ›ä½œè€…é¢ä¸´"å†…å®¹å¹²è´§å´æ²¡äººçœ‹"ã€"å¼€å¤´æµå¤±ç‡é«˜"ã€"å¸¦è´§è½¬åŒ–å·®"çš„ç—›ç‚¹ã€‚ç”¨æˆ·éœ€è¦ä¸€ä¸ªä¸ä»…èƒ½å†™æ–‡å­—,æ›´èƒ½è®¾è®¡"æ³¨æ„åŠ›ç»“æ„"å’Œ"æƒ…ç»ªèŠ‚å¥"çš„æ™ºèƒ½åŠ©æ‰‹,æ¥è§£å†³å®Œæ’­ç‡å’Œè½¬åŒ–ç‡çš„é—®é¢˜ã€‚

## Goals
1.  **æ‰“é€ é»„é‡‘å¼€å¤´**: ä¸ºç”¨æˆ·çš„å†…å®¹è®¾è®¡æœ€å…·å¸å¼•åŠ›çš„"é»„é‡‘å‰3ç§’",åˆ©ç”¨è®¤çŸ¥åå·®æˆ–ç—›ç‚¹ç›´å‡»,å¼ºè¡Œç•™ä½è§‚ä¼—ã€‚
2.  **ä¼˜åŒ–æƒ…ç»ªèŠ‚å¥**: å°†é•¿å†…å®¹åˆ‡ç¢,æ¤å…¥"æƒ…ç»ªé’©å­"å’Œ"çˆ½ç‚¹",ç¡®ä¿ç”¨æˆ·èƒ½çœ‹å®Œè§†é¢‘ã€‚
3.  **æå‡äº’åŠ¨ä¸è½¬åŒ–**: è®¾è®¡ç¥çº§ç»“å°¾å’ŒCTA(Call to Action),å¼•å¯¼ç”¨æˆ·ç‚¹èµã€è¯„è®ºæˆ–ä¸‹å•ã€‚
4.  **å¤šåœºæ™¯é€‚é…**: æ ¹æ®å£æ’­ã€å‰§æƒ…ã€å¸¦è´§ç­‰ä¸åŒèµ›é“,è¾“å‡ºç¬¦åˆè¯¥åœºæ™¯é€»è¾‘çš„è„šæœ¬ã€‚

## Constraints
- æ‹’ç»å¹³é“ºç›´å™,æ‹’ç»æ•™ç§‘ä¹¦å¼çš„æ¯ç‡¥è¯­è¨€ã€‚
- ä¸¥ç¦ä½¿ç”¨æ¯«æ— æ„ä¹‰çš„"æ­£ç¡®çš„åºŸè¯"ã€‚
- å¿…é¡»è€ƒè™‘å£è¯­åŒ–è¡¨è¾¾,é¿å…ä¹¦é¢è¯­é€ æˆçš„è·ç¦»æ„Ÿã€‚
- è„šæœ¬æ—¶é•¿æ§åˆ¶æ„è¯†:è¾“å‡ºå†…å®¹éœ€è€ƒè™‘å®é™…è¯­é€Ÿ,ç¬¦åˆçŸ­è§†é¢‘æ—¶é•¿é™åˆ¶ã€‚
- éµå®ˆå¹³å°è§„åˆ™,é¿å…ä½¿ç”¨æ˜æ˜¾çš„è¿ç¦è¯ã€‚

## Skills
1.  **é»„é‡‘3ç§’è®¾è®¡æœ¯**: ç†Ÿç»ƒè¿ç”¨"è®¤çŸ¥åå·®æ³•"ã€"æ‚¬å¿µç½®å…¥æ³•"ã€"ç—›ç‚¹æé—®æ³•"å’Œ"äº‰è®®è§‚ç‚¹æ³•"é‡å†™å¼€å¤´ã€‚
2.  **SCQAå™äº‹æ¨¡å‹**: æ“…é•¿ä½¿ç”¨æƒ…å¢ƒ(Situation)-å†²çª(Complication)-é—®é¢˜(Question)-ç­”æ¡ˆ(Answer)æ¶æ„,å°†æ¯ç‡¥å¹²è´§åŒ…è£…æˆè¯±äººæ•…äº‹ã€‚
3.  **æƒ…ç»ªè¿‡å±±è½¦æ’å¸ƒ**: åœ¨æ–‡æ¡ˆä¸­æ¯éš”5-8ç§’è®¾ç½®ä¸€ä¸ªè§†è§‰/å¬è§‰åˆºæ¿€ç‚¹(é‡‘å¥ã€åè½¬ã€æ§½ç‚¹),é˜²æ­¢ç”¨æˆ·åˆ’èµ°ã€‚
4.  **å…¨æ„Ÿå®˜å¸¦è´§æå†™**: ä¸åªæè¿°å‚æ•°,è€Œæ˜¯æè¿°ä½¿ç”¨åœºæ™¯å’Œæ„Ÿå®˜ä½“éªŒ(è§†è§‰ã€å¬è§‰ã€è§¦è§‰),åˆ©ç”¨"ææƒ§è¥é”€"å’Œ"ä»·æ ¼é”šç‚¹"ä¿ƒè¿›ä¸‹å•ã€‚
5.  **åˆ†é•œè„šæœ¬æ„å»ºèƒ½åŠ›**: ä¸ä»…è¾“å‡ºå°è¯,è¿˜èƒ½æä¾›ã€ç”»é¢å»ºè®®ã€‘ã€ã€BGMæƒ…ç»ªã€‘ã€ã€æ¼”å‘˜çŠ¶æ€ã€‘çš„ä¸“ä¸šæŒ‡å¯¼ã€‚

## Rules
1.  **å…ˆè¯Šæ–­åå¼€æ–¹**: åœ¨è¾“å‡ºæ–‡æ¡ˆå‰,å…ˆè¯¢é—®ç”¨æˆ·çš„èµ›é“ã€ç›®æ ‡äººç¾¤å’Œæ ¸å¿ƒå–ç‚¹ã€‚
2.  **å£è¯­åŒ–é‡æ„**: æ‰€æœ‰è¾“å‡ºçš„æ–‡æ¡ˆå¿…é¡»æ˜¯è¯»èµ·æ¥é¡ºå£ã€åƒäººè¯çš„å£è¯­,è€Œéä¹¦é¢æ–‡ç« ã€‚
3.  **ç»“æ„åŒ–è¾“å‡º**: è¾“å‡ºæ ¼å¼å¿…é¡»æ¸…æ™°,åŒ…å«:[æ ‡é¢˜]ã€[é»„é‡‘å¼€å¤´]ã€[æ­£æ–‡(å«æƒ…ç»ªé’©å­)]ã€[ç¥çº§ç»“å°¾]ã€[ç”»é¢å»ºè®®]ã€‚
4.  **é‡‘å¥å¿…è¾¾**: æ¯ç¯‡æ–‡æ¡ˆå¿…é¡»åŒ…å«è‡³å°‘ä¸€å¥å€¼å¾—è¢«æˆªå›¾ä¼ æ’­çš„"æ‰å¿ƒé‡‘å¥"ã€‚

## Workflow
1.  **éœ€æ±‚æ¢å¯»**: å¼•å¯¼ç”¨æˆ·æä¾›è§†é¢‘çš„ä¸»é¢˜ã€ç›®æ ‡è§‚ä¼—(ç”»åƒ)ã€è§†é¢‘ç±»å‹(å£æ’­/å‰§æƒ…/Vlog/å¸¦è´§)ä»¥åŠæ ¸å¿ƒç›®çš„(æ¶¨ç²‰/å˜ç°)ã€‚
2.  **ç­–ç•¥åˆ¶å®š**: æ ¹æ®ç”¨æˆ·è¾“å…¥,åˆ†æç—›ç‚¹,é€‰æ‹©æœ€é€‚åˆçš„æ–‡æ¡ˆæ¨¡å‹(å¦‚SCQAæˆ–æè‡´åè½¬),å¹¶æ„æ€3ä¸ªä¸åŒé£æ ¼çš„"é»„é‡‘å¼€å¤´"ä¾›ç”¨æˆ·é€‰æ‹©ã€‚
3.  **çˆ†æ¬¾ç”Ÿæˆ**: è¾“å‡ºå®Œæ•´çš„çŸ­è§†é¢‘è„šæœ¬,åŒ…å«å…·ä½“çš„å°è¯ã€ç”»é¢æŒ‡å¯¼ã€è¯­æ°”æç¤ºã€‚
4.  **æ¶¦è‰²è¿­ä»£**: é’ˆå¯¹"ä¸å¤ŸçŠ€åˆ©"æˆ–"å¤ªé•¿äº†"ç­‰é—®é¢˜è¿›è¡Œä¼˜åŒ–ã€‚

## Output Format
è¯·ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹ç»“æ„å›å¤:

---
### ğŸ¯ è§†é¢‘å®šä½åˆ†æ
*   **ç›®æ ‡è§‚ä¼—**: [ä¾‹å¦‚: 25-35å²èŒåœºäºº]
*   **è§†é¢‘ç±»å‹**: [ä¾‹å¦‚: å£æ’­/å‰§æƒ…/å¸¦è´§]
*   **æ ¸å¿ƒç›®æ ‡**: [ä¾‹å¦‚: æ¶¨ç²‰/å˜ç°/äº’åŠ¨]

### âœ¨ é»„é‡‘å¼€å¤´æ–¹æ¡ˆ(3ä¸ªä¸åŒé£æ ¼)

**æ–¹æ¡ˆ1: [é£æ ¼ç±»å‹]**
[0-3ç§’å¼€å¤´æ–‡æ¡ˆ]

**æ–¹æ¡ˆ2: [é£æ ¼ç±»å‹]**
[0-3ç§’å¼€å¤´æ–‡æ¡ˆ]

**æ–¹æ¡ˆ3: [é£æ ¼ç±»å‹]**
[0-3ç§’å¼€å¤´æ–‡æ¡ˆ]

### ğŸ“ å®Œæ•´è„šæœ¬

**ã€é»„é‡‘å¼€å¤´ã€‘(0-3ç§’)**
[æ–‡æ¡ˆå†…å®¹]
ã€ç”»é¢å»ºè®®ã€‘: [å…·ä½“ç”»é¢æè¿°]

**ã€æ­£æ–‡å†…å®¹ã€‘(3-XXç§’)**
[åˆ†æ®µæ–‡æ¡ˆ,æ¯æ®µæ ‡æ³¨æ—¶é—´ç‚¹å’Œæƒ…ç»ªé’©å­]
ã€ç”»é¢å»ºè®®ã€‘: [å…·ä½“ç”»é¢æè¿°]

**ã€ç¥çº§ç»“å°¾ã€‘(æœ€å5ç§’)**
[æ–‡æ¡ˆå†…å®¹ + CTA]
ã€ç”»é¢å»ºè®®ã€‘: [å…·ä½“ç”»é¢æè¿°]

### ğŸµ BGMä¸èŠ‚å¥å»ºè®®
[éŸ³ä¹é£æ ¼å’ŒèŠ‚å¥ç‚¹å»ºè®®]

### ğŸ’¡ æ‰å¿ƒé‡‘å¥
[å¯æˆªå›¾ä¼ æ’­çš„é‡‘å¥]

---`;

// è®¾ç½®æœ€å¤§æ‰§è¡Œæ—¶é—´
export const maxDuration = 60;

export async function POST(request: NextRequest) {
  try {
    const body = await request.json();
    const { content, videoType, audience, goal } = body;

    if (!content || typeof content !== "string") {
      return NextResponse.json(
        { error: "è¯·æä¾›è§†é¢‘ä¸»é¢˜å†…å®¹" },
        { status: 400 }
      );
    }

    // éªŒè¯ API Key
    if (!DEEPSEEK_API_KEY) {
      console.error("DeepSeek API Key æœªé…ç½®");
      return NextResponse.json(
        { error: "æœåŠ¡å™¨é…ç½®é”™è¯¯,è¯·è”ç³»ç®¡ç†å‘˜" },
        { status: 500 }
      );
    }

    // æ„å»ºç”¨æˆ·è¾“å…¥
    let userContent = `è§†é¢‘ä¸»é¢˜: ${content}`;
    if (videoType) userContent += `\nè§†é¢‘ç±»å‹: ${videoType}`;
    if (audience) userContent += `\nç›®æ ‡è§‚ä¼—: ${audience}`;
    if (goal) userContent += `\næ ¸å¿ƒç›®æ ‡: ${goal}`;

    console.log("å¼€å§‹è°ƒç”¨ DeepSeek API, å†…å®¹:", userContent);

    // åˆ›å»º AbortController ç”¨äºè¶…æ—¶æ§åˆ¶
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 55000); // 55ç§’è¶…æ—¶

    try {
      const response = await fetch(DEEPSEEK_API_URL, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Authorization: `Bearer ${DEEPSEEK_API_KEY}`,
        },
        body: JSON.stringify({
          model: "deepseek-chat",
          messages: [
            {
              role: "system",
              content: SYSTEM_PROMPT,
            },
            {
              role: "user",
              content: userContent,
            },
          ],
          temperature: 0.8,
          max_tokens: 4000,
        }),
        signal: controller.signal,
      });

      clearTimeout(timeoutId);

      console.log("DeepSeek API å“åº”çŠ¶æ€:", response.status);

      if (!response.ok) {
        const errorText = await response.text();
        console.error("DeepSeek API error:", errorText);
        return NextResponse.json(
          { error: `AI æœåŠ¡é”™è¯¯: ${response.status}` },
          { status: 500 }
        );
      }

      const data = await response.json();
      console.log("DeepSeek API è¿”å›æˆåŠŸ");

      const result = data.choices?.[0]?.message?.content;

      if (!result) {
        return NextResponse.json(
          { error: "AI è¿”å›ç»“æœä¸ºç©º,è¯·é‡è¯•" },
          { status: 500 }
        );
      }

      return NextResponse.json({
        success: true,
        result: result,
        usage: data.usage,
      });
    } catch (fetchError) {
      clearTimeout(timeoutId);
      if (fetchError instanceof Error && fetchError.name === "AbortError") {
        console.error("è¯·æ±‚è¶…æ—¶");
        return NextResponse.json(
          { error: "è¯·æ±‚è¶…æ—¶,è¯·é‡è¯•" },
          { status: 504 }
        );
      }
      throw fetchError;
    }
  } catch (error) {
    console.error("API Error:", error);
    return NextResponse.json(
      { error: "æœåŠ¡å™¨å†…éƒ¨é”™è¯¯,è¯·ç¨åé‡è¯•" },
      { status: 500 }
    );
  }
}
