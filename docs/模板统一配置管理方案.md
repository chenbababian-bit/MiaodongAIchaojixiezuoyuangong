# 模板统一配置管理方案

## 一、问题概述

### 1.1 核心问题
同名模板出现在多个页面中，配置不一致，需要统一管理。

**发现的同名模板问题：**
- **公众号文章撰写**：ID 3, 109, 201, 204
- **小红书爆款文案**：ID 1, 102
- 其他可能存在的同名模板

### 1.2 当前架构问题
1. **三套配置系统并存**：
   - `lib/template-config.ts`（未使用）
   - `lib/template-name-registry.ts`（部分使用）
   - `components/media-page.tsx`中的分散数组（实际使用）

2. **路由混乱**：
   - 公众号模板路由到xiaohongshu页面
   - 路由配置不统一

3. **API端点重复**：
   - `/api/wechat-article`（旧版）
   - `/api/official-account-article`（新版）

4. **组件硬编码**：
   - 大量ID判断逻辑
   - 难以维护和扩展

## 二、解决方案

### 2.1 统一配置结构

**采用单一配置文件：`lib/template-config.ts`**

```typescript
export interface TemplateConfig {
  id: number;                    // 主ID
  legacyIds?: number[];          // 旧ID列表（向后兼容）
  category: TemplateCategory;    // 分类
  title: string;                 // 标题
  desc: string;                  // 描述
  icon: string;                  // 图标
  iconBg: string;                // 背景色
  apiEndpoint: string;           // API端点
  routePath: string;             // 路由路径
  pageComponent: string;         // 页面组件
  customFields?: CustomField[];  // 自定义表单字段
  examplePrompts?: string[];     // 示例提示词
  welcomeText?: string;          // 欢迎文本
  enableConversationHistory?: boolean;  // 是否启用对话历史
}
```

### 2.2 ID统一规则

**ID分配范围：**
- 小红书：101-199
- 公众号：201-299
- 头条：301-399
- 微博：401-499
- 知乎：501-599
- 私域：601-699

**同名模板ID迁移：**
- **公众号文章撰写**：保留ID 201，废弃3/109/204
- **小红书爆款文案**：保留ID 102，废弃1

### 2.3 向后兼容方案

通过`legacyIds`字段保持向后兼容：

```typescript
201: {
  id: 201,
  legacyIds: [3, 109, 204],
  title: "公众号文章撰写",
  // ...
}

102: {
  id: 102,
  legacyIds: [1],
  title: "小红书爆款文案",
  // ...
}
```

工具函数自动处理ID映射：
```typescript
export function getTemplateById(id: number): TemplateConfig | null {
  // 直接查找
  if (TEMPLATE_REGISTRY[id]) return TEMPLATE_REGISTRY[id];

  // 查找legacyIds
  for (const template of Object.values(TEMPLATE_REGISTRY)) {
    if (template.legacyIds?.includes(id)) return template;
  }

  return null;
}
```

### 2.4 路由统一

**修正路由配置：**
- 公众号模板 → `/writing/wechat`
- 小红书模板 → `/writing/xiaohongshu`

**自动重定向：**
```typescript
useEffect(() => {
  const templateId = parseInt(searchParams.get("template"));
  const canonicalId = getCanonicalId(templateId);
  const template = getTemplateById(canonicalId);

  if (canonicalId !== templateId || pathname !== template.routePath) {
    router.replace(`${template.routePath}?template=${canonicalId}&title=${template.title}`);
  }
}, [searchParams]);
```

### 2.5 API整合

**保留：** `/api/official-account-article`（功能更完善）
**废弃：** `/api/wechat-article`

### 2.6 组件重构

**消除硬编码ID判断，使用配置驱动：**

```typescript
const templateConfig = getTemplateById(templateId);

// 动态渲染表单
const renderCustomFields = () => {
  return templateConfig.customFields?.map(field => (
    <DynamicFormField key={field.name} config={field} />
  ));
};

// 动态选择API
const handleSubmit = async () => {
  await fetch(templateConfig.apiEndpoint, {
    method: "POST",
    body: JSON.stringify({
      content: formData,
      conversationHistory: templateConfig.enableConversationHistory ? history : undefined
    })
  });
};
```

## 三、实施步骤

### 阶段一：配置系统重构
1. 完善`lib/template-config.ts`，迁移所有模板数据
2. 创建ID映射表和工具函数
3. 添加单元测试

### 阶段二：API整合
1. 统一API端点配置
2. 删除冗余API或添加重定向

### 阶段三：路由修正
1. 修正所有模板的routePath配置
2. 更新`media-page.tsx`使用配置驱动路由

### 阶段四：组件重构
1. 创建动态表单组件（DynamicFormField）
2. 重构页面组件，消除硬编码ID判断
3. 使用配置驱动UI渲染

### 阶段五：向后兼容处理
1. 添加URL自动重定向
2. 更新所有内部链接
3. 添加废弃警告

### 阶段六：测试与文档
1. 全面测试所有模板
2. 测试向后兼容性
3. 更新开发文档

## 四、关键文件

**需要修改的文件：**
- `lib/template-config.ts` - 统一配置文件
- `components/media-page.tsx` - 模板列表页
- `components/xiaohongshu-writing-page.tsx` - 写作页面
- `app/api/wechat-article/route.ts` - API端点
- `app/api/official-account-article/route.ts` - API端点

**需要创建的文件：**
- `lib/template-id-mapping.ts` - ID映射工具
- `components/dynamic-form-field.tsx` - 动态表单组件

## 五、验证方案

### 5.1 功能测试
- [ ] 所有模板的路由跳转正常
- [ ] 表单提交和API调用正常
- [ ] 对话历史功能正常

### 5.2 兼容性测试
- [ ] 旧ID（3, 109, 204）能正常访问并重定向到201
- [ ] 旧ID（1）能正常访问并重定向到102
- [ ] 旧URL能自动重定向到正确路由

### 5.3 回归测试
- [ ] 所有现有功能正常工作
- [ ] 历史记录正常显示
- [ ] 用户书签仍然有效

## 六、风险控制

### 6.1 潜在风险
- 破坏现有功能
- 用户书签失效
- 历史记录不兼容

### 6.2 缓解措施
- 分阶段实施，充分测试
- 保持向后兼容（legacyIds + 重定向）
- 数据迁移脚本

## 七、未来扩展

### 7.1 新增模板流程简化

**旧流程（需要修改多处）：**
1. 在media-page.tsx添加模板数据
2. 在页面组件添加ID判断
3. 创建专用API
4. 添加路由配置

**新流程（只需修改配置）：**
1. 在template-config.ts添加一条配置
2. 完成！

### 7.2 支持插件化

未来可以支持外部插件注册模板，进一步提升扩展性。

## 八、总结

本方案通过统一配置管理、ID规范化、向后兼容处理，彻底解决同名模板配置不一致的问题，同时大幅提升系统的可维护性和扩展性。
