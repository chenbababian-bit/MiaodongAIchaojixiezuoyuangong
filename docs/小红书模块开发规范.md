# 小红书模块开发规范

## 📋 文档说明

本文档记录了小红书模块开发的统一规范和要求，确保所有基于小红书模块作为模板开发的新功能都遵循相同的标准。

**创建时间：** 2026-02-06
**适用范围：** 所有使用小红书模块作为模板的新功能开发

---

## 🎯 核心规范

### 1. 前端对话框格式要求

**重要：前端对话框中不得出现emoji和markdown格式**

#### 1.1 禁止使用的格式

❌ **禁止使用emoji表情符号**
- 不使用任何emoji，如：📝、📚、🎯、💬、🚀、✅、👋等
- 所有欢迎消息和AI回复都应使用纯文本

❌ **禁止使用markdown格式标记**
- 不使用加粗：`**文本**`
- 不使用标题：`# 标题`、`## 标题`等
- 不使用分隔线：`---`
- 不使用代码块：` ``` `
- 不使用引用：`>`

#### 1.2 推荐使用的格式

✅ **使用纯文本格式**
- 使用普通文本描述
- 使用冒号和换行来组织内容结构
- 使用数字列表（1. 2. 3.）来表示步骤
- 使用短横线（-）来表示列表项

#### 1.3 示例对比

**错误示例：**
```
👋 您好！我是**小红书爆款文案大师**

我可以帮您：
- 📝 创作高转化的爆款文案
- 🎯 制定内容策略
- 🚀 提升流量表现

**接下来的工作流程：**
1️⃣ **需求诊断** - 了解您的需求
```

**正确示例：**
```
您好！我是小红书爆款文案大师

我可以帮您：
- 创作高转化的爆款文案
- 制定内容策略
- 提升流量表现

接下来的工作流程：
1. 需求诊断 - 了解您的需求
```

---

## 🔧 实施方法

### 2.1 欢迎消息清理

在页面组件中定义欢迎消息时，确保：

```typescript
// ✅ 正确示例
const WELCOME_MESSAGE = `您好!我是小红书爆款文案大师,拥有50年实战经验。

我可以帮您:
- 创作高转化的爆款文案
- 制定内容策略和运营规划
- 优化现有内容,提升流量表现

请告诉我您的具体需求。`;

// ❌ 错误示例
const WELCOME_MESSAGE = `👋 您好!我是**小红书爆款文案大师**,拥有50年实战经验。

我可以帮您:
- 📝 创作高转化的爆款文案
- 🎯 制定内容策略和运营规划
- 🚀 优化现有内容,提升流量表现

请告诉我您的具体需求。`;
```

### 2.2 系统提示词要求

在API端点的系统提示词中，也应遵循相同的格式要求：

```typescript
const SYSTEM_PROMPT = `# 小红书爆款文案大师

重要格式要求：请使用纯文本格式输出，不要使用Markdown格式标记（如 ###、**、---、- 等）。直接输出文案内容即可。

## 角色定位
你是一位拥有50年实战经验的小红书爆款文案大师...
`;
```

---

## 📝 开发检查清单

在完成新功能开发后，请检查以下项目：

### 格式规范检查
- [ ] 前端欢迎消息不包含emoji
- [ ] 前端欢迎消息不包含markdown格式标记
- [ ] 系统提示词中明确要求使用纯文本格式输出
- [ ] 所有列表项使用短横线（-）而非emoji
- [ ] 所有步骤使用数字（1. 2. 3.）而非emoji数字
- [ ] 所有强调内容使用冒号或换行而非加粗标记

### 类型安全检查
- [ ] 在`lib/conversations.ts`中添加新的类型定义（如`DataAnalysisType`）
- [ ] 在`lib/conversations.ts`中添加类型映射函数（如`getDataAnalysisTypeByTemplateId`）
- [ ] 在组件中导入类型映射函数，不在组件内部定义
- [ ] 确保类型名称使用连字符（kebab-case）
- [ ] 运行`npm run build`验证TypeScript编译通过
- [ ] 提交前检查是否有类似的类型错误

---

## ⚠️ 常见部署错误

### TypeScript类型错误 - 对话类型不匹配

#### 问题描述
在创建新的写作模块时，如果在组件内部定义了`getConversationType`函数来映射模板ID到对话类型，可能会导致TypeScript类型错误和部署失败。

#### 出现次数
- 第1次：抖音运营模块 (commit: 756f1de)
- 第2次：数据分析模块 (commit: 87479b7, 修复: d81980e)

#### 错误原因
1. **类型定义不一致**：组件内部定义的类型名称与`lib/conversations.ts`中定义的类型不匹配
   - 错误示例：使用下划线 `data_analysis_video_play`
   - 正确示例：使用连字符 `data-analysis-video-play`

2. **重复定义**：在组件内部重新定义了类型映射函数，而`lib/conversations.ts`中已经有统一的类型映射函数

#### 解决方案

**步骤1：导入统一的类型映射函数**

在组件文件中导入对应的类型映射函数：

```typescript
// 错误 ❌
import {
  createConversation,
  getConversations,
  addMessage,
  type Conversation as DBConversation,
} from "@/lib/conversations";

// 正确 ✅
import {
  createConversation,
  getConversations,
  addMessage,
  getDataAnalysisTypeByTemplateId,  // 添加类型映射函数
  type Conversation as DBConversation,
} from "@/lib/conversations";
```

**步骤2：删除组件内部的类型映射函数**

删除组件内部定义的`getConversationType`函数：

```typescript
// 删除这段代码 ❌
const getConversationType = (templateId: number): string => {
  switch (templateId) {
    case 5001: return "data_analysis_video_play";  // 错误的类型名称
    // ...
  }
};
```

**步骤3：使用导入的类型映射函数**

在所有使用`getConversationType`的地方，替换为导入的函数：

```typescript
// 错误 ❌
const conversationType = getConversationType(parseInt(templateId));

// 正确 ✅
const conversationType = getDataAnalysisTypeByTemplateId(parseInt(templateId));
```

#### 可用的类型映射函数

根据不同的模块，使用对应的类型映射函数：

| 模块 | 函数名 | 文件位置 |
|------|--------|----------|
| 小红书 | `getXiaohongshuTypeByTemplateId` | `lib/conversations.ts` |
| 抖音 | `getDouyinTypeByTemplateId` | `lib/conversations.ts` |
| 快手 | `getKuaishouTypeByTemplateId` | `lib/conversations.ts` |
| 数据分析 | `getDataAnalysisTypeByTemplateId` | `lib/conversations.ts` |
| 微博 | `getWeiboTypeByTemplateId` | `lib/conversations.ts` |
| 知乎 | `getZhihuTypeByTemplateId` | `lib/conversations.ts` |
| 视频文案 | `getVideoTypeByTemplateId` | `lib/conversations.ts` |

#### 预防措施

在创建新的写作模块时：

1. ✅ **优先使用统一的类型定义**：检查`lib/conversations.ts`中是否已有对应的类型映射函数
2. ✅ **遵循命名规范**：对话类型使用连字符（kebab-case），如`data-analysis-video-play`
3. ✅ **参考现有模块**：查看其他已完成的模块（如小红书、抖音）的实现方式
4. ✅ **本地测试**：在提交前运行`npm run build`确保TypeScript编译通过

#### 相关提交记录

- 抖音模块修复：`756f1de fix(douyin): 修复TypeScript类型错误和导入问题`
- 数据分析模块修复：`d81980e fix(data-analysis): 修复TypeScript类型错误，使用统一的类型映射函数`

---

### 模板卡片点击不跳转 - 缺少TEMPLATE_REGISTRY配置

#### 问题描述
在创建新的写作模块后，点击模板卡片无法跳转到对应的页面，控制台可能显示"Template XXX not found"错误。

#### 出现次数
- 第1次：小红书模块（早期版本）
- 第2次：直播话术模块 (2026-02-07)

#### 错误原因
新模块的模板配置未添加到`lib/template-config.ts`的`TEMPLATE_REGISTRY`中。导航系统依赖这个中心化的配置表来获取模板的路由路径。

**技术细节：**
1. 用户点击模板卡片时，`components/media-page.tsx`中的`handleTemplateClick`函数会被调用
2. 该函数调用`getTemplateById(canonicalId)`从`TEMPLATE_REGISTRY`获取模板配置
3. 如果模板ID不在注册表中，`getTemplateById`返回`null`
4. 由于`template.routePath`为`undefined`，导航失败

#### 解决方案

**步骤1：确认模板信息**

检查模板定义文件（如`lib/live-templates.ts`），确认所有模板的：
- ID范围（如6001-6013）
- 标题和描述
- 图标和颜色
- 对应的API端点

**步骤2：添加TEMPLATE_REGISTRY配置**

在`lib/template-config.ts`的`TEMPLATE_REGISTRY`中添加所有模板配置：

```typescript
// ========== 直播话术类 (6001-6013) ==========
6001: {
  id: 6001,
  category: "live",
  title: "直播产品卖点话术",
  desc: "设计能够吸引目标观众的直播话术,提高产品销售。",
  icon: "🎙️",
  iconBg: "bg-purple-500",
  apiEndpoint: "/api/live-product-selling",
  routePath: "/writing/live-streaming",
},
// ... 其他模板配置
```

**步骤3：验证配置**

确保每个模板配置包含所有必需字段：
- `id`: 模板ID（数字）
- `category`: 分类（如"live"、"xiaohongshu"等）
- `title`: 标题
- `desc`: 描述
- `icon`: 图标（emoji或图片路径）
- `iconBg`: 背景色类名（如"bg-purple-500"）
- `apiEndpoint`: API端点路径（如"/api/live-product-selling"）
- `routePath`: 页面路由路径（如"/writing/live-streaming"）

**步骤4：测试导航**

1. 启动开发服务器：`npm run dev`
2. 访问对应的模块页面
3. 点击每个模板卡片，确认能正确跳转

#### 预防措施

在创建新的写作模块时：

1. ✅ **同步更新TEMPLATE_REGISTRY**：创建模板定义文件的同时，立即在`lib/template-config.ts`中添加对应配置
2. ✅ **使用检查清单**：
   - [ ] 创建模板定义文件（如`lib/xxx-templates.ts`）
   - [ ] 创建页面组件（如`app/writing/xxx/page.tsx`）
   - [ ] 创建API端点（如`app/api/xxx/route.ts`）
   - [ ] **添加TEMPLATE_REGISTRY配置**（关键步骤）
   - [ ] 测试模板卡片点击跳转
3. ✅ **参考现有模块**：查看其他已完成模块的`TEMPLATE_REGISTRY`配置格式
4. ✅ **批量添加**：如果模块有多个模板，一次性添加所有配置，避免遗漏

#### 相关文件

- 模板配置中心：`lib/template-config.ts`
- 导航处理逻辑：`components/media-page.tsx`（`handleTemplateClick`函数）
- 模板定义示例：`lib/live-templates.ts`、`lib/xiaohongshu-templates.ts`

#### 相关提交记录

- 直播话术模块修复：待提交 `fix(live-streaming): 添加13个直播话术模板到TEMPLATE_REGISTRY，修复导航问题`

---

## 🔄 历史模块更新

### 已完成清理的模块

#### 数据分析模块（2026-02-07）
- ✅ 短视频播放分析（5001）
- ✅ 短视频观众分析（5002）
- ✅ 直播成交数据分析（5003）
- ✅ 直播观看数据分析（5004）
- ✅ 短视频互动分析（5005）
- ✅ 短视频成交分析（5006）

**清理内容：**
- 删除所有emoji表情符号（👋📊🎯🔍🏆📈💰💬🎬📝🚀🤖👥1️⃣2️⃣3️⃣4️⃣等）
- 删除所有markdown格式标记（### 标题、** 加粗）
- 统一使用纯文本格式

**相关提交：**
- 初始实现：`87479b7 feat(data-analysis): 实现数据分析模块6个功能的完整对话模式和系统提示词`
- 类型错误修复：`d81980e fix(data-analysis): 修复TypeScript类型错误，使用统一的类型映射函数`
- 格式清理：待提交

#### 快手运营模块（2026-02-06）
- ✅ 快手账号名称（4001）
- ✅ 快手带货口播文案（4002）
- ✅ 快手分镜头脚本（4003）
- ✅ 快手爆款标题（4004）
- ✅ 快手账号简介（4005）

**清理内容：**
- 删除所有emoji表情符号（📱✨🚀👋📱🎥🔥💡1️⃣2️⃣3️⃣4️⃣✅等）
- 删除所有markdown加粗标记（**文本**）
- 统一使用纯文本格式

#### 私域运营模块（2026-02-06）
- ✅ 私域日常文案库（601）
- ✅ 私域朋友圈发文计划库（602）
- ✅ 私域价值感文案库（603）
- ✅ 私域产品营销文案库（604）
- ✅ 私域客户回复助手（605）
- ✅ 私域社群活动策划（606）
- ✅ 私域社群规则生成库（607）

**清理内容：**
- 删除所有emoji表情符号
- 删除所有markdown加粗标记（**文本**）
- 统一使用纯文本格式

---

## 📚 参考资料

### 相关文档
- [小红书爆款标题功能开发文档](./小红书爆款标题功能开发文档.md)
- [小红书爆款文案统一配置验证报告](./小红书爆款文案统一配置验证报告.md)

### 技术实现
- 文件位置：`app/writing/[module]/page.tsx`
- 欢迎消息定义：页面组件顶部常量
- 系统提示词：`app/api/[module]/route.ts`

---

## 🔍 常见问题

### Q: 为什么要禁止使用emoji和markdown格式？
A: 为了保持界面的专业性和一致性，避免格式混乱，确保所有用户看到的内容都是统一的纯文本格式。

### Q: 如果需要强调某些内容怎么办？
A: 使用冒号、换行和缩进来组织内容结构，使用数字列表和短横线列表来表示层级关系。

### Q: 系统提示词中可以使用markdown吗？
A: 系统提示词内部可以使用markdown来组织结构（因为这是给AI看的），但必须明确要求AI输出时使用纯文本格式。

---

## 📅 更新日志

| 日期 | 版本 | 更新内容 | 更新人 |
|------|------|----------|--------|
| 2026-02-07 | 1.3 | 添加数据分析模块清理记录（5001-5006） | Claude Sonnet 4.5 |
| 2026-02-07 | 1.2 | 添加常见部署错误章节，记录TypeScript类型错误解决方案 | Claude Sonnet 4.5 |
| 2026-02-06 | 1.1 | 添加快手运营模块清理记录（4001-4005） | Claude Sonnet 4.5 |
| 2026-02-06 | 1.0 | 创建文档，添加格式规范和私域运营模块清理记录 | Claude Sonnet 4.5 |

---

**维护者：** 开发团队
**最后更新：** 2026-02-07
